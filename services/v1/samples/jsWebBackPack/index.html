<html>
<head>
<title>Web Back Pack</title>
<link rel='stylesheet' type='text/css' href='wbp.css' />
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="formatdata.js"></script>
<script type="text/javascript" src="jszip/jszip.js"></script>
<script type="text/javascript" src="jszip/jszip-load.js"></script>
<script type="text/javascript" src="jszip/jszip-deflate.js"></script>
<script type="text/javascript" src="jszip/jszip-inflate.js"></script>
<script type="text/javascript">
        var gameJSON;
	function sendRequest(fn, params)
	{
        	var xmlhttp;
        	xmlhttp=new XMLHttpRequest();
        	xmlhttp.open("POST","../../../../json.php/v1."+fn,false);
        	xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        	xmlhttp.send(params); //Synchronous call

        	var response=JSON.parse(xmlhttp.responseText);
		//alert(xmlhttp.responseText);
		if(response.returnCode == 1) //Error
		{
			document.getElementById('playerBackPacks').innerHTML = response.data;	
		}
		else
		{
			//document.getElementById('playerBackPacks').innerHTML = "Success!-<br />"+response.data;	
			formatPage(response.data);
                        gameJSON = response.data;
		}
	}

	function parseURLParams(url) {
  		var queryStart = url.indexOf("?") + 1;
  		var queryEnd   = url.indexOf("#") + 1 || url.length + 1;
  		var query      = url.slice(queryStart, queryEnd - 1);
	
  		var params  = {};
  		if (query === url || query === "") return params;
  		var nvPairs = query.replace(/\+/g, " ").split("&");

  		for (var i=0; i<nvPairs.length; i++) {
    			var nv = nvPairs[i].split("=");
    			var n  = decodeURIComponent(nv[0]);
    			var v  = decodeURIComponent(nv[1]);
    			if ( !(n in params) ) {
      				params[n] = [];
    			}
    			params[n].push(nv.length === 2 ? v : null);
  		}
  		return params;
	}

	function pageLoad()
	{
		var gameId;
		if(gameId = parseInt(parseURLParams(document.URL).gameId))
		{
			var bpRequestObject = new Object();
			bpRequestObject.gameId = gameId;
                        if(playerId = parseInt(parseURLParams(document.URL).playerId))
                          bpRequestObject.playerArray = playerId;
                        //alert(JSON.stringify(bpRequestObject));
			sendRequest("players.getPlayerBackpacksFromArray", JSON.stringify(bpRequestObject));
		}
		else
			document.getElementById('playerBackPacks').innerHTML = "<form>Game Id:<input type='text' id='game_id_form'/><input type='button' value='Submit' onClick='submitForm();'/></form>";
	}

	function submitForm()
	{
		var gameId;
		if(gameId = document.getElementById('game_id_form').value)
		{	
			var bpRequestObject = new Object();
			bpRequestObject.gameId = gameId;
			sendRequest("players.getPlayerBackpacksFromArray", JSON.stringify(bpRequestObject));
		}
		else
			alert("Please Enter a Valid Game ID");
	}

        function dump()
        {
            var zip = new JSZip();
            zip.file("jsondata.txt", JSON.stringify(gameJSON));
            preloadDumpMedia(gameJSON);
            var players = zip.folder("players");
            for(var i = 0; i < gameJSON.backpacks.length; i++)
            {
                var player = players.folder(gameJSON.backpacks[i].owner.user_name);
                for(var j = 0; j < gameJSON.backpacks[i].notes.length; j++)
                {
                    var nTitle = gameJSON.backpacks[i].notes[j].title;
                    var tags = "";
                    for(var k = 0; k < gameJSON.backpacks[i].notes[j].tags.length; k++)
                    {
                        tags += gameJSON.backpacks[i].notes[j].tags[k].tag+", ";
                    }
                    if(tags != "")
                    {
                        tags = tags.substr(0, tags.length-2);
                        tags = " ("+tags+")";
                    }
                    nTitle+=tags+" "+gameJSON.backpacks[i].notes[j].note_id;
                    var note = player.folder(nTitle);
                    for(var k = 0; k < gameJSON.backpacks[i].notes[j].contents.length; k++)
                    {
                        var content = gameJSON.backpacks[i].notes[j].contents[k];
                        switch(content.type)
                        {
                            case "TEXT":
                                note.file(content.title+".txt", content.text);
                                break;
                            case "PHOTO":
                                note.file(content.title+content.media_url.substr(content.media_url.length-4, 4), getImageData(content.img,content.media_url.substr(content.media_url.length-4, 4)), {base64: true});
                                break;
                            case "AUDIO":
                                note.file(content.title+content.media_url.substr(content.media_url.length-4, 4), content.media_url, {base64: true});
                                break;
                            case "VIDEO":
                                note.file(content.title+content.media_url.substr(content.media_url.length-4, 4), content.media_url, {base64: true});
                                break;
                        }
                    }
                    var comments = note.folder("comments");
                    for(var k = 0; k < gameJSON.backpacks[i].notes[j].comments.length; k++)
                    {
                        var c = gameJSON.backpacks[i].notes[j].comments[k];
                        var comment = comments.folder(c.username+" "+c.note_id);
                        comment.file("text.txt", c.title);
                        for(var l = 0; l < c.contents.length; l++)
                        {
                            var cc = c.contents[l];
                            if(cc.type == "PHOTO")
                            {
                                comment.file(cc.title+cc.media_url.substr(cc.media_url.length-4, 4), getImageData(cc.img,cc.media_url.substr(cc.media_url.length-4, 4)), {base64: true});
                            }
                        }
                    }
                }
            }
            var content = zip.generate();
            location.href = "data:application/zip;base64," + content;
        }

        function preloadDumpMedia(game)
        {
            for(var i = 0; i < game.backpacks.length; i++)
            {
                var backpack = game.backpacks[i];
                for(var j = 0; j < backpack.notes.length; j++)
                {
                    var note = backpack.notes[j];
                    for(var k = 0; k < note.contents.length; k++)
                    {
                        var content = note.contents[k];
                        if(content.type == "PHOTO")
                        {
                            content.img = new Image();
                            content.img.src = ""+content.media_url;
                        }
                    }
                    for(var k = 0; k < note.comments.length; k++)
                    {
                        var comment = note.comments[k];
                        for(var l = 0; l < comment.contents.length; l++)
                        {
                            var ccontent = comment.contents[l];
                            if(ccontent.type == "PHOTO")
                            {
                                ccontent.img = new Image();
                                ccontent.img.src = ""+content.media_url;
                            }
                        }
                    }
                }
            }
        }

        function getImageData(img,type)
        {
            if(!canvas) canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            if(!ctx) ctx = canvas.getContext("2d");
            ctx.drawImage(img,0,0);
            cdata = canvas.toDataURL("image/"+type);
            return cdata.replace(/^data:image\/(png|jpg);base64,/, "");
        }
        var canvas;
        var ctx;
        var cdata;

</script>
</head>
<body onload='pageLoad()' id='body'>
<div id='playerBackPacks'> Waiting on Server... </div>
</body>
</html>
